<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>virosolver vignette -- simulated data • virosolver</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="virosolver vignette -- simulated data">
<meta property="og:description" content="virosolver">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">virosolver</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/vignette.html">virosolver vignette -- simulated data</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="vignette_files/header-attrs-2.3/header-attrs.js"></script><script src="vignette_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>virosolver vignette – simulated data</h1>
            
      
      
      <div class="hidden name"><code>vignette.Rmd</code></div>

    </div>

    
    
<p>This vignette exhaustively steps through the code, model checks and fitting prodecure to use <code>virosolver</code> to estimate incidence curves from simulated data. This code can be adapted for your own datasets by replacing the Ct data frame, here called <code>example_ct_data</code>. Note that for your own datasets, substantial callibration and checks are advised.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">virosolver</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jameshay218/lazymcmc" class="external-link">lazymcmc</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/foreach" class="external-link">foreach</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">doParallel</span><span class="op">)</span>

<span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">4</span>, setup_strategy <span class="op">=</span> <span class="st">"sequential"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></code></pre></div>
<div id="rationale" class="section level2">
<h2 class="hasAnchor">
<a href="#rationale" class="anchor" aria-hidden="true"></a>1. Rationale</h2>
<p><code>virosolver</code> takes an input data frame of cycle threshold (Ct) values with associated sample collection dates from quantitative reverse transcription PCR (RT-qPCR) testing, and reconstructs the incidence curve that gave rise to those measurements. The logic is as follows:</p>
<ul>
<li>There is an unobserved incidence curve that describes the generation of new infections over time;</li>
<li>Susceptible individuals may become infected at some point in time with probability equal to the per-capita incidence on each day;</li>
<li>Following infection, viral loads in the infected individual follow some set of predictable kinetics (ie. viral loads go up then down);</li>
<li>Individuals are sampled at random from the population (a random cross-sectional sample), and thus an individual’s viral load is measured at some unknown point (as a Ct value) in their infection course;</li>
<li>If we mostly measure low viral loads, then most of the individuals we sampled were in the late stage of their infection and incidence was likely declining, but if we mostly measure high viral loads, then most individuals were early on in their infection course and incidence was likely growing.</li>
</ul>
<p>By capturing this logic in a mathematical model, we can obtain a probabilistic estimate of the underlying incidence curve having observed a set of Ct values at some point in time.</p>
<p>To summarize, the key idea is that you can estimate incidence based on cross-sections of observed Ct values. This case study explores the application of <code>virosolver</code> to SARS-CoV-2 surveillance. A full explanation can be found in the accompanying <a href="https://doi.org/10.1101/2020.10.08.20204222" class="external-link">paper</a>.</p>
</div>
<div id="data" class="section level2">
<h2 class="hasAnchor">
<a href="#data" class="anchor" aria-hidden="true"></a>2. Data</h2>
<p><code>virosolver</code> expects a data frame as input data in long format, where each row corresponds to one tested sample. There should be one column labeled <code>t</code>, giving the time in days a sample was taken, and one column labeled <code>ct</code>, giving the Ct value of that tested sample. Note that Ct values are semi-quantitative and their scale depends on the platform/instrument used. It is assumed that all Ct values within the data frame are on the same scale and therefore internally consistent across time points. For this simulation, we assume that 1000 random samples are obtained every 2 weeks, starting from day 55.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">example_ct_data</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">example_ct_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ct</span> <span class="op">&lt;</span> <span class="fl">40</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">## # A tibble: 6 x 2</span>
<span class="co">##       t    ct</span>
<span class="co">##   &lt;int&gt; &lt;dbl&gt;</span>
<span class="co">## 1    55  29.9</span>
<span class="co">## 2    55  18.9</span>
<span class="co">## 3    55  28.0</span>
<span class="co">## 4    55  31.0</span>
<span class="co">## 5    55  33.6</span>
<span class="co">## 6    69  38.3</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Plot only detectable Ct values</span>
<span class="va">p_ct_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">example_ct_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ct</span> <span class="op">&lt;</span> <span class="fl">40</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html" class="external-link">geom_violin</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">t</span>,group<span class="op">=</span><span class="va">t</span>,y<span class="op">=</span><span class="va">ct</span><span class="op">)</span>,scale<span class="op">=</span><span class="st">"width"</span>,fill<span class="op">=</span><span class="st">"grey70"</span>,draw_quantiles<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>,<span class="fl">0.5</span>,<span class="fl">0.975</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html" class="external-link">geom_jitter</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">t</span>,y<span class="op">=</span><span class="va">ct</span><span class="op">)</span>,size<span class="op">=</span><span class="fl">0.1</span>,width<span class="op">=</span><span class="fl">2</span>,height<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>trans<span class="op">=</span><span class="st">"reverse"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Ct value"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Observation time"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Observed Ct values &lt; 40 (the limit of detection) over time"</span><span class="op">)</span>
<span class="va">p_ct_data</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p_detectable_data</span> <span class="op">&lt;-</span> <span class="va">example_ct_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>detect<span class="op">=</span><span class="va">ct</span> <span class="op">&lt;</span> <span class="fl">40</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>prev<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">detect</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">t</span>,y<span class="op">=</span><span class="va">prev</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.6</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Proportion detectable"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Proportion of samples with Ct values &lt; 40"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Observation time"</span><span class="op">)</span> 
<span class="co">## `summarise()` ungrouping output (override with `.groups` argument)</span>
<span class="va">p_detectable_data</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>A script to generate these data can be found in the <code>extdata</code> folder, found <a href="https://github.com/jameshay218/virosolver/tree/master/man/inst/extdata" class="external-link">here</a>.</p>
</div>
<div id="ct-model" class="section level2">
<h2 class="hasAnchor">
<a href="#ct-model" class="anchor" aria-hidden="true"></a>3. Ct model</h2>
<p>A key part of the model is the assumed viral kinetics curve. This describes the mode and variation of Ct values on each day post infection. This is the population-level distribution – it does not track individual-level viral kinetics curve, so the variation about the mode captures <em>all</em> variation arising from sampling variation, individual-level heterogeneity etc. It is <em>CRUCIAL</em> to understand the parameters underpinning this model when applying <code>virosolver</code> to a new dataset, as this calibration will be entirely dependent on the population being tested and the PCR instrument used. Consider questions like “what are the mean and range of Ct values I expect to see if I test someone on my platform <em>x</em> days post infection?”, “what proportion of positive samples taken <em>x</em> days post infection do I expect to test positive?”.</p>
<p>We assume the following Ct model for this simulation:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">example_gp_partab</span><span class="op">)</span>
<span class="va">pars</span> <span class="op">&lt;-</span> <span class="va">example_gp_partab</span><span class="op">$</span><span class="va">values</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pars</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">example_gp_partab</span><span class="op">$</span><span class="va">names</span>

<span class="co">## Solve the Ct model over a range of times since infection (referred to as "ages")</span>
<span class="va">test_ages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">50</span>,by<span class="op">=</span><span class="fl">1</span><span class="op">)</span>

<span class="co">## This gives the modal Ct value</span>
<span class="va">cts</span> <span class="op">&lt;-</span> <span class="fu">viral_load_func</span><span class="op">(</span><span class="va">pars</span>, <span class="va">test_ages</span><span class="op">)</span>

<span class="va">p_ct_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>ct<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">40</span>,<span class="va">cts</span><span class="op">)</span>,t<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">test_ages</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">t</span>,y<span class="op">=</span><span class="va">ct</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>trans<span class="op">=</span><span class="st">"reverse"</span>,
                     limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">40</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Modal Ct value"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Days since infection"</span><span class="op">)</span>

<span class="co">## Note that this model does not solve for t=0, </span>
<span class="co">## as it is always assumed that no one is detectable 0 days post infection</span>
<span class="va">prop_detect</span> <span class="op">&lt;-</span> <span class="fu">prop_detectable</span><span class="op">(</span><span class="va">test_ages</span>,<span class="va">pars</span>, <span class="va">cts</span><span class="op">)</span>
<span class="va">p_ct_model_detectable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>p<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">prop_detect</span><span class="op">)</span>,t<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">test_ages</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">t</span>,y<span class="op">=</span><span class="va">p</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Proportion of infections\n still detectable"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Days since infection"</span><span class="op">)</span>
<span class="va">p_ct_model</span><span class="op">/</span><span class="va">p_ct_model_detectable</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-5-1.png" width="600"></p>
<p>An intuitive way to look at this curve is to simulate observations from it and plot the simulated Ct values ordered by days since infection. From this, we can see the substantial amount of variation in measurements on each day post infection, but also that there is still some information in the Ct values. Note also that under this model, individuals become truly undetectable (ie. fully recovered) following some daily Bernoulli process. Those who remain detectable for a long time demonstrate a “narrowing” of observed Ct values, where the variation about the mode decreases. This model captures the observation that few individuals remain detectable for a long time, but for those who do, they do not necessarily have Ct values that tend towards the limit of detection.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sim_cts</span> <span class="op">&lt;-</span> <span class="fu">simulate_viral_loads_example</span><span class="op">(</span><span class="va">test_ages</span>, <span class="va">pars</span>,N<span class="op">=</span><span class="fl">200</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sim_cts</span><span class="op">)</span><span class="op">)</span>
<span class="co">## # A tibble: 6 x 3</span>
<span class="co">##     age i        ct</span>
<span class="co">##   &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt;</span>
<span class="co">## 1     1 1      40  </span>
<span class="co">## 2     1 2      40  </span>
<span class="co">## 3     1 3      35.3</span>
<span class="co">## 4     1 4      40  </span>
<span class="co">## 5     1 5      32.5</span>
<span class="co">## 6     1 6      35.2</span>
<span class="va">p_sim_cts_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sim_cts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ct</span> <span class="op">&lt;</span> <span class="fl">40</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">age</span>,y<span class="op">=</span><span class="va">ct</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>trans<span class="op">=</span><span class="st">"reverse"</span>,limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">40</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Ct value"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Days since infection"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Simulated detectable Ct values on each day post infection"</span><span class="op">)</span>
<span class="va">p_sim_cts_age</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-6-1.png" width="600"></p>
</div>
<div id="inference-procedure" class="section level2">
<h2 class="hasAnchor">
<a href="#inference-procedure" class="anchor" aria-hidden="true"></a>4. Inference procedure</h2>
<p>Now that we have our Ct data and understand the assumed viral kinetics underpinning the model, we can get into the inference framework. We use a Markov chain Monte Carlo framework to estimate the posterior distributions of the free model parameters, conditional on the observed Ct data (the likelihood) and any priors we wish to place on the Ct model and incidence curve parameters. We’ll step through the general principles of using the MCMC package, <code>lazymcmc</code>, define priors for key model parameters, and then demonstrate how the model works using either a single cross section of data or multiple cross sections.</p>
<div id="parameter-control-table" class="section level3">
<h3 class="hasAnchor">
<a href="#parameter-control-table" class="anchor" aria-hidden="true"></a>4.1 Parameter control table</h3>
<p><code>lazymcmc</code> uses a data frame (usually called <code>parTab</code> or <code>par_tab</code>) to track model parameters. The table allows users to fix/estimate certain parameters and also to specify upper and lower bounds. See <code><a href="../reference/example_gp_partab.html">?example_gp_partab</a></code> for more information, and refer to the the <a href="https://github.com/jameshay218/lazymcmc" class="external-link"><code>lazymcmc</code></a> vignettes for more detail.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">example_gp_partab</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">example_gp_partab</span><span class="op">)</span>
<span class="co">##       values        names fixed lower_bound upper_bound steps lower_start</span>
<span class="co">## 1  0.5000000 overall_prob     0           0           1   0.1         0.0</span>
<span class="co">## 2  0.0000000       tshift     1           0           3   0.1         0.0</span>
<span class="co">## 3  5.0000000 desired_mode     1           0           7   0.1         0.0</span>
<span class="co">## 4 19.7359875   viral_peak     0           0          40   0.1        15.0</span>
<span class="co">## 5  5.0000000       obs_sd     0           0          25   0.1         1.0</span>
<span class="co">## 6  0.7888288       sd_mod     1           0           1   0.1         0.4</span>
<span class="co">##   upper_start</span>
<span class="co">## 1         1.0</span>
<span class="co">## 2        10.0</span>
<span class="co">## 3        10.0</span>
<span class="co">## 4        25.0</span>
<span class="co">## 5        10.0</span>
<span class="co">## 6         0.6</span>
<span class="co">## Illustration -- set the `viral_peak` parameter to be estimated during the procedure, and the `intercept` parameter to be fixed</span>
<span class="va">example_gp_partab</span> <span class="op">&lt;-</span> <span class="va">example_gp_partab</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">names</span> <span class="op">==</span> <span class="st">"viral_peak"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>fixed<span class="op">=</span><span class="fl">0</span><span class="op">)</span>
<span class="va">example_gp_partab</span> <span class="op">&lt;-</span> <span class="va">example_gp_partab</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">names</span> <span class="op">==</span> <span class="st">"intercept"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>fixed<span class="op">=</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
</div>
<div id="priors" class="section level3">
<h3 class="hasAnchor">
<a href="#priors" class="anchor" aria-hidden="true"></a>4.2 Priors</h3>
<p>We need to specify priors on all estimated model parameters. We use informative priors for the Ct model, as we need to constrain its shape based on our knowledge of viral kinetics to ensure identifiability of the incidence curve. We use less informative priors for the epidemic model, as that’s what we’re interested in estimating. Here, we use the example parameter table to find the <strong>prior means</strong> for each model parameter, and then we set the prior <strong>standard deviations</strong>. We then define a function to be used later, which takes a vector of parameters (with names corresponding to entries in the parameter table), which returns a single log prior probability.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Read in the SEIR model parameter control table</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">example_seir_partab</span><span class="op">)</span>
<span class="co">## Pull out the current values for each parameter, and set these as the prior means</span>
<span class="va">means</span> <span class="op">&lt;-</span> <span class="va">example_seir_partab</span><span class="op">$</span><span class="va">values</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">example_seir_partab</span><span class="op">$</span><span class="va">names</span>
<span class="co">## Set standard deviations of prior distribution</span>
<span class="va">sds_seir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"obs_sd"</span><span class="op">=</span><span class="fl">0.5</span>,<span class="st">"viral_peak"</span><span class="op">=</span><span class="fl">2</span>,
         <span class="st">"wane_rate2"</span><span class="op">=</span><span class="fl">1</span>,<span class="st">"t_switch"</span><span class="op">=</span><span class="fl">3</span>,<span class="st">"level_switch"</span><span class="op">=</span><span class="fl">1</span>,
         <span class="st">"prob_detect"</span><span class="op">=</span><span class="fl">0.03</span>,
         <span class="st">"incubation"</span><span class="op">=</span><span class="fl">0.25</span>, <span class="st">"infectious"</span><span class="op">=</span><span class="fl">0.5</span><span class="op">)</span>

<span class="co">## Define a function that returns the log prior probability for a given vector of parameter</span>
<span class="co">## values in `pars`, given the prior means and standard deviations set above.</span>
<span class="va">prior_func_seir</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pars</span>,<span class="va">...</span><span class="op">)</span><span class="op">{</span>
  <span class="co">## Ct model priors</span>
  <span class="va">obs_sd_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">pars</span><span class="op">[</span><span class="st">"obs_sd"</span><span class="op">]</span>, <span class="va">means</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">==</span> <span class="st">"obs_sd"</span><span class="op">)</span><span class="op">]</span>, <span class="va">sds_seir</span><span class="op">[</span><span class="st">"obs_sd"</span><span class="op">]</span>,log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">viral_peak_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">pars</span><span class="op">[</span><span class="st">"viral_peak"</span><span class="op">]</span>, <span class="va">means</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">==</span> <span class="st">"viral_peak"</span><span class="op">)</span><span class="op">]</span>, <span class="va">sds_seir</span><span class="op">[</span><span class="st">"viral_peak"</span><span class="op">]</span>,log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">wane_2_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">pars</span><span class="op">[</span><span class="st">"wane_rate2"</span><span class="op">]</span>,<span class="va">means</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">==</span> <span class="st">"wane_rate2"</span><span class="op">)</span><span class="op">]</span>,<span class="va">sds_seir</span><span class="op">[</span><span class="st">"wane_rate2"</span><span class="op">]</span>,log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">tswitch_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">pars</span><span class="op">[</span><span class="st">"t_switch"</span><span class="op">]</span>,<span class="va">means</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">==</span> <span class="st">"t_switch"</span><span class="op">)</span><span class="op">]</span>,<span class="va">sds_seir</span><span class="op">[</span><span class="st">"t_switch"</span><span class="op">]</span>,log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">level_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">pars</span><span class="op">[</span><span class="st">"level_switch"</span><span class="op">]</span>,<span class="va">means</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">==</span> <span class="st">"level_switch"</span><span class="op">)</span><span class="op">]</span>,<span class="va">sds_seir</span><span class="op">[</span><span class="st">"level_switch"</span><span class="op">]</span>,log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  <span class="co">## Beta prior on the prob_detect parameter to ensure between 0 and 1</span>
  <span class="va">beta1_mean</span> <span class="op">&lt;-</span> <span class="va">means</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">==</span> <span class="st">"prob_detect"</span><span class="op">)</span><span class="op">]</span>
  <span class="va">beta1_sd</span> <span class="op">&lt;-</span> <span class="va">sds_seir</span><span class="op">[</span><span class="st">"prob_detect"</span><span class="op">]</span>
  <span class="va">beta_alpha</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">beta1_mean</span><span class="op">)</span><span class="op">/</span><span class="va">beta1_sd</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="fl">1</span><span class="op">/</span><span class="va">beta1_mean</span><span class="op">)</span><span class="op">*</span><span class="va">beta1_mean</span><span class="op">^</span><span class="fl">2</span>
  <span class="va">beta_beta</span> <span class="op">&lt;-</span> <span class="va">beta_alpha</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="va">beta1_mean</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>
  <span class="va">beta_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">dbeta</a></span><span class="op">(</span><span class="va">pars</span><span class="op">[</span><span class="st">"prob_detect"</span><span class="op">]</span>,<span class="va">beta_alpha</span>,<span class="va">beta_beta</span>,log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  
  <span class="co">## SEIR model priors</span>
  <span class="va">incu_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">dlnorm</a></span><span class="op">(</span><span class="va">pars</span><span class="op">[</span><span class="st">"incubation"</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">means</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">==</span> <span class="st">"incubation"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, <span class="va">sds_seir</span><span class="op">[</span><span class="st">"incubation"</span><span class="op">]</span>, <span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">infectious_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">dlnorm</a></span><span class="op">(</span><span class="va">pars</span><span class="op">[</span><span class="st">"infectious"</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">means</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">==</span> <span class="st">"infectious"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,<span class="va">sds_seir</span><span class="op">[</span><span class="st">"infectious"</span><span class="op">]</span>,<span class="cn">TRUE</span><span class="op">)</span>
  
  <span class="co">## Sum up</span>
  <span class="va">obs_sd_prior</span> <span class="op">+</span> <span class="va">viral_peak_prior</span> <span class="op">+</span> 
    <span class="va">wane_2_prior</span> <span class="op">+</span> <span class="va">tswitch_prior</span> <span class="op">+</span> <span class="va">level_prior</span> <span class="op">+</span> <span class="va">beta_prior</span> <span class="op">+</span>
    <span class="va">incu_prior</span> <span class="op">+</span> <span class="va">infectious_prior</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="likelihood-and-posterior-function" class="section level3">
<h3 class="hasAnchor">
<a href="#likelihood-and-posterior-function" class="anchor" aria-hidden="true"></a>4.3 Likelihood and posterior function</h3>
<p>Next, we need a function to give the <strong>likelihood</strong> of observing a particular set of Ct values conditional on the underlying model parameters. Part of this is to determine the function for the <strong>probability of infection over time</strong> (the incidence curve). <code>virosolver</code> has some prebuilt functions for this, and here we’ll be using the SEIR model to describe incidence. We can then use <code>create_posterior_func</code> to create a new function which calculates the posterior probability of a set of parameter values conditional on the Ct data. This function expects a vector of model parameters with names corresponding to the parameter control table and returns a single log posterior probability. Note that the parameter vector needs entries for each parameter needed to solve both the Ct model and the incidence model.</p>
<p>Note that the <code>use_pos</code> argument is important. If you want to fit the model using <em>ALL</em> PCR results (ie. including samples testing negative), you should set this to <code>FALSE</code>. If your data only includes positive Ct values (ie. only Ct values &lt; the LOD), then you should set this to <code>TRUE</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Point to a function that expects a vector of named parameters and returns a vector of daily infection probabilities/incidence</span>
<span class="va">incidence_function</span> <span class="op">&lt;-</span> <span class="va">solveSEIRModel_lsoda_wrapper</span>

<span class="co">## Use the example parameter table</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">example_seir_partab</span><span class="op">)</span>

<span class="co">## Create the posterior function used in the MCMC framework</span>
<span class="va">posterior_func</span> <span class="op">&lt;-</span> <span class="fu">create_posterior_func</span><span class="op">(</span>parTab<span class="op">=</span><span class="va">example_seir_partab</span>,
                                        data<span class="op">=</span><span class="va">example_ct_data</span>,
                                        PRIOR_FUNC<span class="op">=</span><span class="va">prior_func_seir</span>,
                                        INCIDENCE_FUNC<span class="op">=</span><span class="va">incidence_function</span>,
                                        use_pos<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co">## Important argument, see text</span>

<span class="co">## Test with default parameters to find the log likelihood</span>
<span class="fu">posterior_func</span><span class="op">(</span><span class="va">example_seir_partab</span><span class="op">$</span><span class="va">values</span><span class="op">)</span>
<span class="co">##    obs_sd </span>
<span class="co">## -6006.231</span></code></pre></div>
</div>
<div id="estimating-incidence-from-a-single-cross-section" class="section level3">
<h3 class="hasAnchor">
<a href="#estimating-incidence-from-a-single-cross-section" class="anchor" aria-hidden="true"></a>4.4 Estimating incidence from a single cross section</h3>
<p>We’ll now demonstrate how to use <code>virosolver</code> to estimate an SEIR-generated incidence curve from a single-cross section of data. We’ll use Ct values from the fifth sampling time, and then run the MCMC framework. This timepoint was chosen as the posterior distribution is unimodal – if you use timepoints with multi-modal posteriors, you’ll need to use the parallel tempering branch of <code>lazymcmc</code>. The majority of Ct values are undetectable, so we’ll just look at the distribution of Ct values below the limit of detection.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Filter to Ct values on day 111 (fifth timepoint)</span>
<span class="va">ct_data_use</span> <span class="op">&lt;-</span> <span class="va">example_ct_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">t</span> <span class="op">==</span> <span class="fl">111</span><span class="op">)</span>
<span class="va">p_ct_use</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">ct_data_use</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ct</span> <span class="op">&lt;</span> <span class="fl">40</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">ct</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">p_ct_use</span>
<span class="co">## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-10-1.png" width="600"></p>
<p>First, we need to set random starting values for the MCMC procedure.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Function from the virosolver package to generate random starting parameter values that return a finite likelihood</span>
<span class="va">start_tab</span> <span class="op">&lt;-</span> <span class="fu">generate_viable_start_pars</span><span class="op">(</span><span class="va">example_seir_partab</span>,<span class="va">ct_data_use</span>,
                                                      <span class="va">create_posterior_func</span>,
                                                      <span class="va">incidence_function</span>,
                                                      <span class="va">prior_func_seir</span><span class="op">)</span></code></pre></div>
<p>Depending on the MCMC settings we wish to use (see the <code>lazymcmc</code> documentation), we need to do some additional set up. <code>covMat</code>,<code>mvrPars</code> and <code>mcmc_pars</code> specify needed objects for the Metropolis-Hastings algorithm, as well as the length of the MCMC chain.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">covMat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">start_tab</span><span class="op">)</span><span class="op">)</span>
<span class="va">mvrPars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">covMat</span>,<span class="fl">2.38</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">start_tab</span><span class="op">[</span><span class="va">start_tab</span><span class="op">$</span><span class="va">fixed</span><span class="op">==</span><span class="fl">0</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span>,w<span class="op">=</span><span class="fl">0.8</span><span class="op">)</span>
<span class="va">mcmc_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"iterations"</span><span class="op">=</span><span class="fl">200000</span>,<span class="st">"popt"</span><span class="op">=</span><span class="fl">0.234</span>,<span class="st">"opt_freq"</span><span class="op">=</span><span class="fl">2000</span>,
                    <span class="st">"thin"</span><span class="op">=</span><span class="fl">1000</span>,<span class="st">"adaptive_period"</span><span class="op">=</span><span class="fl">100000</span>,<span class="st">"save_block"</span><span class="op">=</span><span class="fl">100</span><span class="op">)</span></code></pre></div>
<p>This is where the magic happens: <code>run_MCMC</code> takes in all of the objects we’ve set up and runs the full MCMC procedure.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">"mcmc_chains/readme_single_cross_section"</span>,recursive<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>

<span class="co">##################################</span>
<span class="co">## RUN THE MCMC FRAMEWORK</span>
<span class="co">## Run 3 MCMC chains. Note that it is possible to parallelize this loop with foreach and doPar</span>
<span class="co">## Note the `use_pos` argument needs to be set here too</span>
<span class="va">nchains</span> <span class="op">&lt;-</span> <span class="fl">3</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">foreach</a></span><span class="op">(</span>chain_no<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">nchains</span>,.packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"virosolver"</span>,<span class="st">"lazymcmc"</span>,<span class="st">"extraDistr"</span>,<span class="st">"tidyverse"</span>,<span class="st">"patchwork"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">%dopar%</a></span> <span class="op">{</span>
  <span class="va">outputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lazymcmc/man/run_MCMC.html" class="external-link">run_MCMC</a></span><span class="op">(</span>parTab<span class="op">=</span><span class="va">start_tab</span>,
                           data<span class="op">=</span><span class="va">ct_data_use</span>,
                           INCIDENCE_FUNC<span class="op">=</span><span class="va">incidence_function</span>,
                           PRIOR_FUNC<span class="op">=</span><span class="va">prior_func_seir</span>,
                           mcmcPars<span class="op">=</span><span class="va">mcmc_pars</span>,
                           filename<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"mcmc_chains/readme_single_cross_section/readme_seir_"</span>,<span class="va">chain_no</span><span class="op">)</span>,
                           CREATE_POSTERIOR_FUNC<span class="op">=</span><span class="va">create_posterior_func</span>,
                           mvrPars<span class="op">=</span><span class="va">mvrPars</span>,
                          use_pos<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co">## Important argument</span>
<span class="op">}</span></code></pre></div>
<p>After the MCMC sampling is finished, we use a function from <code>lazymcmc</code> to load in all of the MCMC chains, and we then use <code>ggplot2</code> to investigate the trace plots to check for convergence. You should check other convergence diagnostics like effective sample size and Rhat, but that is beyond the scope of this vignette.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Read in the MCMC chains</span>
<span class="va">chains</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lazymcmc/man/load_mcmc_chains.html" class="external-link">load_mcmc_chains</a></span><span class="op">(</span>location<span class="op">=</span><span class="st">"mcmc_chains/readme_single_cross_section"</span>,
                           parTab<span class="op">=</span><span class="va">start_tab</span>,
                           burnin<span class="op">=</span><span class="va">mcmc_pars</span><span class="op">[</span><span class="st">"adaptive_period"</span><span class="op">]</span>,
                           chainNo<span class="op">=</span><span class="cn">TRUE</span>,
                           unfixed<span class="op">=</span><span class="cn">TRUE</span>,
                           multi<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## [1] "mcmc_chains/readme_single_cross_section/readme_seir_1_multivariate_chain.csv"</span>
<span class="co">## [2] "mcmc_chains/readme_single_cross_section/readme_seir_2_multivariate_chain.csv"</span>
<span class="co">## [3] "mcmc_chains/readme_single_cross_section/readme_seir_3_multivariate_chain.csv"</span>
<span class="co">## [[1]]</span>
<span class="co">## [1] 201</span>
<span class="co">## </span>
<span class="co">## [[2]]</span>
<span class="co">## [1] 201</span>
<span class="co">## </span>
<span class="co">## [[3]]</span>
<span class="co">## [1] 201</span>
<span class="co">## Reshape for plotting</span>
<span class="va">chains_melted</span> <span class="op">&lt;-</span> <span class="va">chains</span><span class="op">$</span><span class="va">chain</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">as_tibble</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">chain</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sampno<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sampno</span>,<span class="va">chain</span><span class="op">)</span><span class="op">)</span>
<span class="co">## Look at trace plots</span>
<span class="va">p_trace</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">chains_melted</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">sampno</span>,y<span class="op">=</span><span class="va">value</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">chain</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name</span>,scales<span class="op">=</span><span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_d</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">"Chain"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Iteration"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Value"</span><span class="op">)</span>
<span class="va">p_trace</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>We also use the MCMC chains (loaded with <code>unfixed=FALSE</code> here to include all fixed parameters) to solve the model using a number of posterior draws. This allows us to construct credible intervals on the model predictions and to visualize the inferred incidence curve. We compare this to the true (blue) incidence curve to see how accurate the estimates are. We can see that the posterior draws nicely capture the blue line, demonstrating that the recovered incidence curve is close to the true value.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Load in MCMC chains again, but this time read in the fixed parameters too </span>
<span class="co">## to ensure that the posterior draws are compatible with the model functions</span>
<span class="va">chains</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lazymcmc/man/load_mcmc_chains.html" class="external-link">load_mcmc_chains</a></span><span class="op">(</span>location<span class="op">=</span><span class="st">"mcmc_chains/readme_single_cross_section"</span>,
                           parTab<span class="op">=</span><span class="va">start_tab</span>,
                           burnin<span class="op">=</span><span class="va">mcmc_pars</span><span class="op">[</span><span class="st">"adaptive_period"</span><span class="op">]</span>,
                           chainNo<span class="op">=</span><span class="cn">FALSE</span>,
                           unfixed<span class="op">=</span><span class="cn">FALSE</span>,
                           multi<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## [1] "mcmc_chains/readme_single_cross_section/readme_seir_1_multivariate_chain.csv"</span>
<span class="co">## [2] "mcmc_chains/readme_single_cross_section/readme_seir_2_multivariate_chain.csv"</span>
<span class="co">## [3] "mcmc_chains/readme_single_cross_section/readme_seir_3_multivariate_chain.csv"</span>
<span class="co">## [[1]]</span>
<span class="co">## [1] 201</span>
<span class="co">## </span>
<span class="co">## [[2]]</span>
<span class="co">## [1] 201</span>
<span class="co">## </span>
<span class="co">## [[3]]</span>
<span class="co">## [1] 201</span>
<span class="co">## Do some reshaping to allow correct subsampling (we need each sampno to correspond to one unique posterior draw)</span>
<span class="va">chain_comb</span> <span class="op">&lt;-</span> <span class="va">chains</span><span class="op">$</span><span class="va">chain</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sampno<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## Load in true incidence curve to compare to our prediction</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">example_seir_incidence</span><span class="op">)</span>
<span class="va">predictions</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_prob_infection.html">plot_prob_infection</a></span><span class="op">(</span><span class="va">chain_comb</span>, 
                                   nsamps<span class="op">=</span><span class="fl">100</span>, 
                                   INCIDENCE_FUNC<span class="op">=</span><span class="va">incidence_function</span>,
                                  solve_times<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ct_data_use</span><span class="op">$</span><span class="va">t</span><span class="op">)</span>,
                                   obs_dat<span class="op">=</span><span class="va">ct_data_use</span>,
                                  true_prob_infection<span class="op">=</span><span class="va">example_seir_incidence</span><span class="op">)</span>
<span class="va">p_incidence_prediction</span> <span class="op">&lt;-</span> <span class="va">predictions</span><span class="op">$</span><span class="va">plot</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">200</span><span class="op">)</span><span class="op">)</span>
<span class="va">p_incidence_prediction</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-15-1.png" width="600"></p>
<p>It’s also a good idea to check things like the estimated daily growth rate and time-varying reproductive number. A bit more computation is involved here, but the key is to check our estimated predictions against the true values.</p>
<pre><code>## `summarise()` ungrouping output (override with `.groups` argument)
## `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<p><img src="vignette_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<p>We also check the model-predicted Ct distribution against the used data – this is a visual assessment of model fit.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Use create_posterior_func to return the predicted Ct distribution rather than the posterior probability</span>
<span class="va">model_func</span> <span class="op">&lt;-</span> <span class="fu">create_posterior_func</span><span class="op">(</span><span class="va">example_seir_partab</span>,<span class="va">ct_data_use</span>,<span class="cn">NULL</span>,<span class="va">incidence_function</span>,<span class="st">"model"</span><span class="op">)</span>
<span class="co">## Pass model_func to a plotting function to observe predicted Ct distribution against data</span>
<span class="va">p_distribution_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_distribution_fits.html">plot_distribution_fits</a></span><span class="op">(</span><span class="va">chain_comb</span>, <span class="va">ct_data_use</span>, <span class="va">model_func</span>,<span class="fl">100</span>,pos_only<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="co">## Joining, by = "t"</span>
<span class="co">## Joining, by = c("t", "sampno")</span>
<span class="co">## Coordinate system already present. Adding new coordinate system, which will replace the existing one.</span>
<span class="va">p_distribution_fit</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-17-1.png" width="729.166666666667"></p>
</div>
<div id="estimating-incidence-from-multiple-cross-sections" class="section level3">
<h3 class="hasAnchor">
<a href="#estimating-incidence-from-multiple-cross-sections" class="anchor" aria-hidden="true"></a>4.5 Estimating incidence from multiple cross sections</h3>
<p>The final part of this case study is to use a Gaussian Process prior to estimate the full incidence curve using all cross-sections of Ct values. The overall set up is identical, but we need to use a new incidence function, new prior function and new parameter table corresponding to the new incidence model.</p>
<p>Note that we set the <code>incidence_function</code> pointer to <code>gaussian_process_model</code> here, and load in the GP parameter table. We also need to reduce the size of <code>par_tab</code> so that we only solve the model in the range of times given by the data. That is, we only want to find incidence for each day in the vector between t=0 and the final sampling time – we don’t do any forecasting here. We need one entry of <code>prob</code> for each time we’re solving the model for.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## MCMC chain options</span>
<span class="va">mcmc_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"iterations"</span><span class="op">=</span><span class="fl">500000</span>,<span class="st">"popt"</span><span class="op">=</span><span class="fl">0.44</span>,<span class="st">"opt_freq"</span><span class="op">=</span><span class="fl">2000</span>,
                    <span class="st">"thin"</span><span class="op">=</span><span class="fl">2500</span>,<span class="st">"adaptive_period"</span><span class="op">=</span><span class="fl">200000</span>,<span class="st">"save_block"</span><span class="op">=</span><span class="fl">100</span><span class="op">)</span>

<span class="co">## Set pointer to the Gaussian Process model as the incidence function</span>
<span class="va">incidence_function</span> <span class="op">&lt;-</span> <span class="va">gaussian_process_model</span>
<span class="co">## Read in the GP model parameter control table</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">example_gp_partab</span><span class="op">)</span>

<span class="co">## This is for the GP version</span>
<span class="va">times</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">example_ct_data</span><span class="op">$</span><span class="va">t</span><span class="op">)</span>
<span class="va">mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">times</span>, each<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span><span class="op">)</span>,ncol<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span><span class="op">)</span>
<span class="va">t_dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">mat</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">-</span><span class="va">times</span><span class="op">)</span><span class="op">)</span>
<span class="va">par_tab</span> <span class="op">&lt;-</span> <span class="va">example_gp_partab</span>
<span class="va">par_tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">par_tab</span><span class="op">[</span><span class="va">par_tab</span><span class="op">$</span><span class="va">names</span> <span class="op">!=</span> <span class="st">"prob"</span>,<span class="op">]</span>, <span class="va">par_tab</span><span class="op">[</span><span class="va">par_tab</span><span class="op">$</span><span class="va">names</span> <span class="op">==</span> <span class="st">"prob"</span>,<span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span>
<span class="va">pars</span> <span class="op">&lt;-</span> <span class="va">par_tab</span><span class="op">$</span><span class="va">values</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pars</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">par_tab</span><span class="op">$</span><span class="va">names</span>

<span class="co">## Pull out the current values for each parameter, and set these as the prior means</span>
<span class="va">means</span> <span class="op">&lt;-</span> <span class="va">par_tab</span><span class="op">$</span><span class="va">values</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">par_tab</span><span class="op">$</span><span class="va">names</span>

<span class="co">## Set standard deviations of prior distribution</span>
<span class="va">sds_gp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"obs_sd"</span><span class="op">=</span><span class="fl">0.5</span>,<span class="st">"viral_peak"</span><span class="op">=</span><span class="fl">2</span>,
         <span class="st">"wane_rate2"</span><span class="op">=</span><span class="fl">1</span>,<span class="st">"t_switch"</span><span class="op">=</span><span class="fl">3</span>,<span class="st">"level_switch"</span><span class="op">=</span><span class="fl">1</span>,
         <span class="st">"prob_detect"</span><span class="op">=</span><span class="fl">0.03</span>,
         <span class="st">"incubation"</span><span class="op">=</span><span class="fl">0.25</span>, <span class="st">"infectious"</span><span class="op">=</span><span class="fl">0.5</span><span class="op">)</span>

<span class="co">## Define a function that returns the log prior probability for a given vector of parameter</span>
<span class="co">## values in `pars`, given the prior means and standard deviations set above.</span>
<span class="co">## Prior for GP version</span>
<span class="va">prior_func_gp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pars</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span>
  <span class="va">par_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pars</span><span class="op">)</span>
  
  <span class="co">## Viral kinetics parameters</span>
  <span class="va">obs_sd_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">pars</span><span class="op">[</span><span class="st">"obs_sd"</span><span class="op">]</span>, <span class="va">means</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">==</span> <span class="st">"obs_sd"</span><span class="op">)</span><span class="op">]</span>, <span class="va">sds_gp</span><span class="op">[</span><span class="st">"obs_sd"</span><span class="op">]</span>,log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">viral_peak_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">pars</span><span class="op">[</span><span class="st">"viral_peak"</span><span class="op">]</span>, <span class="va">means</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">==</span> <span class="st">"viral_peak"</span><span class="op">)</span><span class="op">]</span>, <span class="va">sds_gp</span><span class="op">[</span><span class="st">"viral_peak"</span><span class="op">]</span>,log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">wane_2_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">pars</span><span class="op">[</span><span class="st">"wane_rate2"</span><span class="op">]</span>,<span class="va">means</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">==</span> <span class="st">"wane_rate2"</span><span class="op">)</span><span class="op">]</span>,<span class="va">sds_gp</span><span class="op">[</span><span class="st">"wane_rate2"</span><span class="op">]</span>,log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">tswitch_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">pars</span><span class="op">[</span><span class="st">"t_switch"</span><span class="op">]</span>,<span class="va">means</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">==</span> <span class="st">"t_switch"</span><span class="op">)</span><span class="op">]</span>,<span class="va">sds_gp</span><span class="op">[</span><span class="st">"t_switch"</span><span class="op">]</span>,log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">level_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">pars</span><span class="op">[</span><span class="st">"level_switch"</span><span class="op">]</span>,<span class="va">means</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">==</span> <span class="st">"level_switch"</span><span class="op">)</span><span class="op">]</span>,<span class="va">sds_gp</span><span class="op">[</span><span class="st">"level_switch"</span><span class="op">]</span>,log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">beta1_mean</span> <span class="op">&lt;-</span> <span class="va">means</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">==</span> <span class="st">"prob_detect"</span><span class="op">)</span><span class="op">]</span>
  <span class="va">beta1_sd</span> <span class="op">&lt;-</span> <span class="va">sds_gp</span><span class="op">[</span><span class="st">"prob_detect"</span><span class="op">]</span>
  <span class="va">beta_alpha</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">beta1_mean</span><span class="op">)</span><span class="op">/</span><span class="va">beta1_sd</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="fl">1</span><span class="op">/</span><span class="va">beta1_mean</span><span class="op">)</span><span class="op">*</span><span class="va">beta1_mean</span><span class="op">^</span><span class="fl">2</span>
  <span class="va">beta_beta</span> <span class="op">&lt;-</span> <span class="va">beta_alpha</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="va">beta1_mean</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>
  <span class="va">beta_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">dbeta</a></span><span class="op">(</span><span class="va">pars</span><span class="op">[</span><span class="st">"prob_detect"</span><span class="op">]</span>,<span class="va">beta_alpha</span>,<span class="va">beta_beta</span>,log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  
  <span class="co">### VERY IMPORTANT</span>
  <span class="co">## Gaussian process prior, un-centered version</span>
  <span class="va">k</span> <span class="op">&lt;-</span> <span class="va">pars</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">par_names</span><span class="op">==</span><span class="st">"prob"</span><span class="op">)</span><span class="op">]</span>
  <span class="co">## Leave this - correct for uncentered version as per Chapter 14 Statistical Rethinking</span>
  <span class="va">prob_priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">k</span>, <span class="fl">0</span>, <span class="fl">1</span>, log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
  <span class="co">#########</span>
  
  <span class="va">nu_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">dexp</a></span><span class="op">(</span><span class="va">pars</span><span class="op">[</span><span class="st">"nu"</span><span class="op">]</span>, <span class="fl">1</span><span class="op">/</span><span class="va">means</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">==</span> <span class="st">"nu"</span><span class="op">)</span><span class="op">]</span>,log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">rho_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">dexp</a></span><span class="op">(</span><span class="va">pars</span><span class="op">[</span><span class="st">"rho"</span><span class="op">]</span>, <span class="fl">1</span><span class="op">/</span><span class="va">means</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">==</span> <span class="st">"rho"</span><span class="op">)</span><span class="op">]</span>,log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  
  <span class="va">obs_sd_prior</span> <span class="op">+</span> <span class="va">viral_peak_prior</span> <span class="op">+</span> <span class="va">wane_2_prior</span> <span class="op">+</span> <span class="va">tswitch_prior</span> <span class="op">+</span>
    <span class="va">level_prior</span> <span class="op">+</span> <span class="va">beta_prior</span> <span class="op">+</span> <span class="va">prob_priors</span> <span class="op">+</span>
    <span class="va">nu_prior</span> <span class="op">+</span> <span class="va">rho_prior</span>
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Check that posterior function solves and returns a finite likelihood</span>
<span class="va">posterior_function</span> <span class="op">&lt;-</span> <span class="fu">create_posterior_func</span><span class="op">(</span>parTab<span class="op">=</span><span class="va">par_tab</span>, 
                                            data<span class="op">=</span><span class="va">example_ct_data</span>, 
                                            PRIOR_FUNC<span class="op">=</span><span class="va">prior_func_gp</span>, 
                                            INCIDENCE_FUNC<span class="op">=</span><span class="va">incidence_function</span>,
                                            t_dist<span class="op">=</span><span class="va">t_dist</span><span class="op">)</span>
<span class="fu">posterior_function</span><span class="op">(</span><span class="va">par_tab</span><span class="op">$</span><span class="va">values</span><span class="op">)</span>
<span class="co">##    obs_sd </span>
<span class="co">## -30983.29</span></code></pre></div>
<p>We’re now ready to solve the full Gaussian Process prior model. This is going to take quite a lot longer than the single cross section SEIR model, as there is far more data and the model solve time is longer. This may take a couple hours to run sufficiently long chains.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">"mcmc_chains/readme_multiple_cross_section"</span>,recursive<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="co">##################################</span>
<span class="co">## RUN THE MCMC FRAMEWORK</span>
<span class="co">## Run 3 MCMC chains. Note that it is possible to parallelize this loop with foreach and doPar</span>
<span class="co">## Note the `use_pos` argument needs to be set here too</span>
<span class="va">nchains</span> <span class="op">&lt;-</span> <span class="fl">3</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">foreach</a></span><span class="op">(</span>chain_no<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">nchains</span>,.packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"virosolver"</span>,<span class="st">"lazymcmc"</span>,<span class="st">"extraDistr"</span>,<span class="st">"tidyverse"</span>,<span class="st">"patchwork"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">%dopar%</a></span> <span class="op">{</span>
  <span class="co">## Get random starting values</span>
  <span class="va">start_tab</span> <span class="op">&lt;-</span> <span class="fu">generate_viable_start_pars</span><span class="op">(</span><span class="va">par_tab</span>,<span class="va">example_ct_data</span>,
                                         <span class="va">create_posterior_func</span>,
                                         <span class="va">incidence_function</span>,
                                         <span class="va">prior_func_gp</span><span class="op">)</span>
  
  <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lazymcmc/man/run_MCMC.html" class="external-link">run_MCMC</a></span><span class="op">(</span>parTab<span class="op">=</span><span class="va">start_tab</span>,
                     data<span class="op">=</span><span class="va">example_ct_data</span>,
                     INCIDENCE_FUNC<span class="op">=</span><span class="va">incidence_function</span>,
                     PRIOR_FUNC<span class="op">=</span><span class="va">prior_func_gp</span>,
                     mcmcPars<span class="op">=</span><span class="va">mcmc_pars</span>,
                     filename<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"mcmc_chains/readme_multiple_cross_section/readme_gp_"</span>,<span class="va">chain_no</span><span class="op">)</span>,
                     CREATE_POSTERIOR_FUNC<span class="op">=</span><span class="va">create_posterior_func</span>,
                     mvrPars<span class="op">=</span><span class="cn">NULL</span>,
                     OPT_TUNING<span class="op">=</span><span class="fl">0.2</span>,
                     use_pos<span class="op">=</span><span class="cn">FALSE</span>,
                     t_dist<span class="op">=</span><span class="va">t_dist</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The remaining steps are the same as the single cross section example. We read in the MCMC chains, check for convergence, and then use the posterior draws to check our estimates.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Read in the MCMC chains</span>
<span class="va">chains</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lazymcmc/man/load_mcmc_chains.html" class="external-link">load_mcmc_chains</a></span><span class="op">(</span>location<span class="op">=</span><span class="st">"mcmc_chains/readme_multiple_cross_section"</span>,
                           parTab<span class="op">=</span><span class="va">par_tab</span>,
                           burnin<span class="op">=</span><span class="va">mcmc_pars</span><span class="op">[</span><span class="st">"adaptive_period"</span><span class="op">]</span>,
                           chainNo<span class="op">=</span><span class="cn">TRUE</span>,
                           unfixed<span class="op">=</span><span class="cn">TRUE</span>,
                           multi<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="co">## [1] "mcmc_chains/readme_multiple_cross_section/readme_gp_1_univariate_chain.csv"</span>
<span class="co">## [2] "mcmc_chains/readme_multiple_cross_section/readme_gp_2_univariate_chain.csv"</span>
<span class="co">## [3] "mcmc_chains/readme_multiple_cross_section/readme_gp_3_univariate_chain.csv"</span>
<span class="co">## [[1]]</span>
<span class="co">## [1] 201</span>
<span class="co">## </span>
<span class="co">## [[2]]</span>
<span class="co">## [1] 201</span>
<span class="co">## </span>
<span class="co">## [[3]]</span>
<span class="co">## [1] 201</span>
<span class="co">## Reshape for plotting</span>
<span class="va">chains_melted</span> <span class="op">&lt;-</span> <span class="va">chains</span><span class="op">$</span><span class="va">chain</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">as_tibble</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">chain</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sampno<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sampno</span>,<span class="va">chain</span><span class="op">)</span><span class="op">)</span>
<span class="co">## Look at trace plots</span>
<span class="va">p_trace_gp</span> <span class="op">&lt;-</span> <span class="va">chains_melted</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"prob."</span>,<span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">sampno</span>,y<span class="op">=</span><span class="va">value</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">chain</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name</span>,scales<span class="op">=</span><span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_d</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">"Chain"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Iteration"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Value"</span><span class="op">)</span>
<span class="va">p_trace_gp</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
<p>Plot predicted incidence curves using posterior draws and compare to the true incidence curve (blue).</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Load in MCMC chains again, but this time read in the fixed parameters too </span>
<span class="co">## to ensure that the posterior draws are compatible with the model functions</span>
<span class="va">chains</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lazymcmc/man/load_mcmc_chains.html" class="external-link">load_mcmc_chains</a></span><span class="op">(</span>location<span class="op">=</span><span class="st">"mcmc_chains/readme_multiple_cross_section/"</span>,
                           parTab<span class="op">=</span><span class="va">par_tab</span>,
                           burnin<span class="op">=</span><span class="va">mcmc_pars</span><span class="op">[</span><span class="st">"adaptive_period"</span><span class="op">]</span>,
                           chainNo<span class="op">=</span><span class="cn">FALSE</span>,
                           unfixed<span class="op">=</span><span class="cn">FALSE</span>,
                           multi<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="co">## [1] "mcmc_chains/readme_multiple_cross_section//readme_gp_1_univariate_chain.csv"</span>
<span class="co">## [2] "mcmc_chains/readme_multiple_cross_section//readme_gp_2_univariate_chain.csv"</span>
<span class="co">## [3] "mcmc_chains/readme_multiple_cross_section//readme_gp_3_univariate_chain.csv"</span>
<span class="co">## [[1]]</span>
<span class="co">## [1] 201</span>
<span class="co">## </span>
<span class="co">## [[2]]</span>
<span class="co">## [1] 201</span>
<span class="co">## </span>
<span class="co">## [[3]]</span>
<span class="co">## [1] 201</span>
<span class="co">## Do some reshaping to allow correct subsampling (we need each sampno to correspond to one unique posterior draw)</span>
<span class="va">chain_comb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">chains</span><span class="op">$</span><span class="va">chain</span><span class="op">)</span>
<span class="va">chain_comb</span><span class="op">$</span><span class="va">sampno</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">chain_comb</span><span class="op">)</span>

<span class="co">## Load in true incidence curve to compare to our prediction</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">example_seir_incidence</span><span class="op">)</span>
<span class="va">predictions</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_prob_infection.html">plot_prob_infection</a></span><span class="op">(</span><span class="va">chain_comb</span>,nsamps<span class="op">=</span><span class="fl">100</span>, INCIDENCE_FUNC<span class="op">=</span><span class="va">incidence_function</span>,
                                  solve_times<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">example_ct_data</span><span class="op">$</span><span class="va">t</span><span class="op">)</span>,obs_dat<span class="op">=</span><span class="va">example_ct_data</span>,
                                  true_prob_infection<span class="op">=</span><span class="va">example_seir_incidence</span>,
                                  smooth<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="co">## Smooth the trajectories a bit</span>
<span class="va">p_incidence_prediction</span> <span class="op">&lt;-</span> <span class="va">predictions</span><span class="op">$</span><span class="va">plot</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">200</span><span class="op">)</span><span class="op">)</span>
<span class="va">p_incidence_prediction</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-22-1.png" width="600"></p>
<p>Check model-predicted Ct distributions against observed data at each cross section.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Use create_posterior_func to return the predicted Ct distribution rather than the posterior probability</span>
<span class="va">model_func_gp</span> <span class="op">&lt;-</span> <span class="fu">create_posterior_func</span><span class="op">(</span><span class="va">par_tab</span>,<span class="va">example_ct_data</span>,<span class="cn">NULL</span>,<span class="va">incidence_function</span>,<span class="st">"model"</span><span class="op">)</span>
<span class="co">## Pass model_func to a plotting function to observe predicted Ct distribution against data</span>
<span class="va">p_distribution_fit_gp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_distribution_fits.html">plot_distribution_fits</a></span><span class="op">(</span><span class="va">chain_comb</span>, <span class="va">example_ct_data</span>, <span class="va">model_func_gp</span>,<span class="fl">100</span>,pos_only<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="co">## Joining, by = "t"</span>
<span class="co">## Joining, by = c("t", "sampno")</span>
<span class="co">## Coordinate system already present. Adding new coordinate system, which will replace the existing one.</span>
<span class="va">p_distribution_fit_gp</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-23-1.png" width="800"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by James Hay.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
